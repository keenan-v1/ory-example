name: Main workflow

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/**"
      - "infra/**/*.tf"
      - "applications/**"
  pull_request:
    branches:
      - main
    paths:
      - "infra/**/*.tf"
      - "applications/**"

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  debug:
    name: Debug
    runs-on: ubuntu-latest
    steps:
      - name: "Debug"
        run: |
          if [ "${{ secrets.TERRAFORM_CLOUD_TOKEN }}" ]; then
            echo "Terraform Cloud token is set"
          else
            echo "Terraform Cloud token is not set"
          fi
          exit 1
  run-infra:
    name: Run Infrastructure
    uses: "./.github/workflows/infra_main.yaml"
    with:
      force-apply: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
    secrets:
      terraform-cloud-token: ${{ secrets.TERRAFORM_CLOUD_TOKEN }}

  run-applications:
    name: Run Applications
    needs: run-infra
    uses: "./.github/workflows/application_main.yaml"
    with:
      force-build: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
      force-deploy: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
